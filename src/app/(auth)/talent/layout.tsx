import { Briefcase, CircleUserRound } from 'lucide-react'
import type { Metadata } from 'next'
import Link from 'next/link'

import { getAuthToken } from '@/lib/auth/token'
import { authRedirect, errorRedirect } from '@/lib/navigation/redirect'
import { userService } from '@/services/user'

import { AvatarDropdown } from './_components/avatar-dropdown'
import { CompanyLogo } from './_components/company-logo'

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
}

const SIDEBAR_LINKS = [
  {
    text: 'Jobs',
    href: '/talent/jobs',
    icon: <Briefcase />,
  },
  {
    text: 'Profile',
    href: '/talent/profile',
    icon: <CircleUserRound />,
  },
]

export default async function TalentLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  const token = getAuthToken()

  if (!token) {
    return authRedirect()
  }

  const result = await userService.getAuthenticatedUser()

  if (result.type === 'failure') {
    return result.reason === 'auth-error' ? authRedirect() : errorRedirect()
  }

  const user = result.data
  const userInitials =
    user.firstName[0].toUpperCase() + user.lastName[0].toUpperCase()

  return (
    <div>
      <div className='absolute right-8 top-6 z-50'>
        <AvatarDropdown name={userInitials} />
      </div>
      <div className='flex w-full'>
        <div className='min-h-screen flex-none basis-72 bg-foreground px-2 py-12'>
          <div className='flex flex-col items-center text-primary-foreground'>
            <CompanyLogo className='mb-6' />
            <ul className='space-y-6'>
              {SIDEBAR_LINKS.map((link, i) => (
                <li key={i} className='flex w-full'>
                  <Link
                    href={link.href}
                    className='flex gap-x-2 text-muted-foreground hover:text-gray-700'
                  >
                    <span>{link.icon}</span>
                    <span>{link.text}</span>
                  </Link>
                </li>
              ))}
            </ul>
          </div>
        </div>
        <div className='grow px-8 py-6'>{children}</div>
      </div>
    </div>
  )
}
